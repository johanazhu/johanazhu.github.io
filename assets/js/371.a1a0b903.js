(window.webpackJsonp=window.webpackJsonp||[]).push([[371],{830:function(t,s,e){"use strict";e.r(s);var a=e(25),n=Object(a.a)({},(function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"微信网页授权"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#微信网页授权"}},[t._v("#")]),t._v(" 微信网页授权")]),t._v(" "),e("p",[t._v("微信网页授权步骤差不多有四步，具体文档可查看"),e("a",{attrs:{href:"https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/Wechat_webpage_authorization.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("这里"),e("OutboundLink")],1),t._v("，我画了下流程图：")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://i.loli.net/2021/09/26/aPZvclQdzDTmjoL.png",alt:"微信授权流程图"}})]),t._v(" "),e("p",[t._v("以下为代码实战")]),t._v(" "),e("h2",{attrs:{id:"第一步-用户同意授权-获取code"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#第一步-用户同意授权-获取code"}},[t._v("#")]),t._v(" 第一步：用户同意授权，获取code")]),t._v(" "),e("p",[t._v("需先调用 "),e("code",[t._v("/auth")]),t._v(" 接口，传入必传参数 "),e("code",[t._v("url")]),t._v(" 以及 "),e("code",[t._v("scope")]),t._v("（此为参数名）")]),t._v(" "),e("p",[t._v("请求方式：GET")]),t._v(" "),e("ul",[e("li",[e("p",[t._v("url 为回调地址")])]),t._v(" "),e("li",[e("p",[t._v("scope 有两个可选参数")]),t._v(" "),e("ul",[e("li",[t._v("snsapi_base 只能获取进入页面用户的 openid，用户无感知，叫静默授权")]),t._v(" "),e("li",[t._v("snsapi_userinfo 能获取用户的基本信息，但需要用户接受，叫手动授权，如下图")])])])]),t._v(" "),e("p",[e("img",{attrs:{src:"https://i.loli.net/2021/05/21/gKzl6PTUmQYos4L.png",alt:"1599707513545"}})]),t._v(" "),e("p",[t._v("具体区别可前往 "),e("a",{attrs:{href:"https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/Wechat_webpage_authorization.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("微信文档"),e("OutboundLink")],1),t._v(" 查看")]),t._v(" "),e("h2",{attrs:{id:"第二步-通过code换取网页授权access-token"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#第二步-通过code换取网页授权access-token"}},[t._v("#")]),t._v(" 第二步：通过code换取网页授权access_token")]),t._v(" "),e("p",[t._v("这里以手动授权为例")]),t._v(" "),e("p",[t._v("获取到微信的 code 后，再请求 "),e("code",[t._v("/getUserInfo")])]),t._v(" "),e("p",[t._v("请求方式： GET")]),t._v(" "),e("p",[t._v("请求参数：code，需请求 "),e("code",[t._v("/auth")]),t._v(" 获取到 "),e("code",[t._v("code")]),t._v(" 先，如果你在请求 "),e("code",[t._v("/auth")]),t._v(" 时传入的 "),e("code",[t._v("scope")]),t._v(" 为 "),e("code",[t._v("snsapi_userinfo")]),t._v(" , 那么返回微信个人信息，包括微信名，性别，所在地区，国籍，头像等等，如下")]),t._v(" "),e("div",{staticClass:"language-javascript extra-class"},[e("pre",{pre:!0,attrs:{class:"language-javascript"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("   \n  "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"openid"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('" OPENID"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"nickname"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NICKNAME")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"sex"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"1"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"province"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"PROVINCE"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"city"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"CITY"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"country"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"COUNTRY"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("        "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"headimgurl"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"https://thirdwx.qlogo.cn/mmopen/g3MonUZtNHkdmzicIlibx6iaFqAc56vxLSUfpb6n5WKSYVY0ChQKkiaJSgQ1dZuTOgvLLrhJbERQQ4eMsv84eavHiaiceqxibJxCfHe/46"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"privilege"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"PRIVILEGE1"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"PRIVILEGE2"')]),t._v("     "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"unionid"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"o6_bmasdasdsad6_2sgVt7hMZOPfL"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("p",[t._v("但如果 "),e("code",[t._v("scope")]),t._v(" 为 "),e("code",[t._v("snsapi_base")]),t._v(" ，请求成功时只返回用户的 "),e("code",[t._v("openid")])]),t._v(" "),e("blockquote",[e("p",[t._v("PS: 请求"),e("code",[t._v("/getOpenId")]),t._v("、 "),e("code",[t._v("/getUserInfo")]),t._v(" 成功时会返回 "),e("code",[t._v("access_token")]),t._v("，但此 "),e("code",[t._v("access_token")]),t._v("  和 微信服务端开发中的 "),e("code",[t._v("access_token")]),t._v(" 不同，一个是微信与服务器打交道（微信票据服务），另一个是微信网页的 OAuth2.0 服务（网页授权）")])]),t._v(" "),e("h2",{attrs:{id:"第三步-请求-userinfo"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#第三步-请求-userinfo"}},[t._v("#")]),t._v(" 第三步：请求 userInfo")]),t._v(" "),e("p",[t._v("拿着 access_token 和 openid，去请求微信官方接口")]),t._v(" "),e("blockquote",[e("p",[e("code",[t._v("http：GET（请使用 https 协议） https://api.weixin.qq.com/sns/userinfo?access_token=ACCESS_TOKEN&openid=OPENID&lang=zh_CN")])])]),t._v(" "),e("p",[t._v("返回openid、nickname、sex、province、city、country、headimgurl 等信息，拿着 openid 和 你想要的数据返回值原来 "),e("code",[t._v("/auth")]),t._v(" 参数中的 url 上")]),t._v(" "),e("h2",{attrs:{id:"实战"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#实战"}},[t._v("#")]),t._v(" 实战")]),t._v(" "),e("p",[t._v("先调用 "),e("code",[t._v("/auth")]),t._v(" 接口，传入参数 url 和 scope")]),t._v(" "),e("p",[t._v("请求接口："),e("code",[t._v("http://192.168.230.209/auth?url=http://192.168.230.209/home&scope=snsapi_userinfo")])]),t._v(" "),e("p",[t._v("redis 存 "),e("code",[t._v("url=http://192.168.230.209/home")]),t._v("，即最后授权完成拿到数据后返回的前端地址")]),t._v(" "),e("p",[t._v("判断参数 scope，如果是 "),e("code",[t._v("snsapi_userinfo")]),t._v("，用户点击授权后跳转至 "),e("code",[t._v("/getWxUserInfo")]),t._v(" 接口；")]),t._v(" "),e("p",[t._v("如果是 "),e("code",[t._v("snsapi_base")]),t._v("，静默授权后跳转至 "),e("code",[t._v("getOpenId")]),t._v(" 接口")]),t._v(" "),e("p",[t._v("这里我们传的 scope 为 "),e("code",[t._v("snsapi_userinfo")]),t._v("，所以请求成功后会有授权页面")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://i.loli.net/2021/05/21/gKzl6PTUmQYos4L.png",alt:"1599707513545"}})]),t._v(" "),e("p",[t._v("点击”同意“会跳转至页面")]),t._v(" "),e("p",[e("code",[t._v("http://192.168.230.209:8888/api/wechat/getWxUserInfo?code=081UcAFa1s1OAz0o7wGa1wb8vG1UcAFX&state=123")])]),t._v(" "),e("blockquote",[e("p",[t._v("PS："),e("code",[t._v("http://192.168.230.209:8888/api/wechat")]),t._v(" 为该后端服务地址，"),e("code",[t._v("getWxUserInfo")]),t._v(" 为路由（即请求接口）")])]),t._v(" "),e("p",[t._v("从"),e("code",[t._v("ctx.request.query")]),t._v(" 中拿到 code，拿着 code 请求 access_token服务，access_token 服务也是微信官方提供的一个方法")]),t._v(" "),e("blockquote",[e("p",[e("code",[t._v("获取code后，请求以下链接获取access_token： https://api.weixin.qq.com/sns/oauth2/access_token?appid=APPID&secret=SECRET&code=CODE&grant_type=authorization_code")])])]),t._v(" "),e("p",[t._v("请求成功的话，拿着这个返回值中的 access_token 和 openid，请求 userinfo 接口，在上文已经介绍过，这里不做重复")]),t._v(" "),e("blockquote",[e("p",[t._v("这里要说明的一点是，如果请求 access_token  的返回 code 为 40029，说明 access_token 已经失效，我们需要重新刷新 access_token")])]),t._v(" "),e("p",[t._v("拿到 userinfo 的返回值后，在最开始存在 redis 中的url上拼接 openid、headimgurl 等即可")]),t._v(" "),e("p",[t._v("这里需要说明一点")]),t._v(" "),e("p",[t._v("需要先配置 OAuth2.0 网页授权的回调页面域名，类似这种")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://i.loli.net/2021/09/27/PufDxSq7m3abZcA.png",alt:"授权回调页面域名"}})]),t._v(" "),e("h2",{attrs:{id:"总结"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),e("p",[t._v("一直要知道一定，微信网页开发和调用微信的 JS-SDK 不一样，也和微信服务端开发不一样")]),t._v(" "),e("p",[t._v("它可以当初拎出来说，坑也比较少，不会遇到像 JS-SDK 那样的各种报错")]),t._v(" "),e("p",[t._v("只要知道，它为为了获取 openid （以及微信个人信息）而弄的一个服务就好了")])])}),[],!1,null,null,null);s.default=n.exports}}]);