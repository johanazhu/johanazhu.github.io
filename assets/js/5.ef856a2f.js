(window.webpackJsonp=window.webpackJsonp||[]).push([[5],{408:function(s,a,t){s.exports=t.p+"assets/img/dockerfile_脚本.e23b796a.png"},409:function(s,a,t){s.exports=t.p+"assets/img/docker_build.f1f9a61c.png"},410:function(s,a,t){s.exports=t.p+"assets/img/导出镜像.eb001613.png"},411:function(s,a,t){s.exports=t.p+"assets/img/lrzsz上传镜像.b4cf955c.png"},412:function(s,a,t){s.exports=t.p+"assets/img/导入镜像.fd7aa24d.png"},413:function(s,a,t){s.exports=t.p+"assets/img/docker_push.8b8d8558.png"},414:function(s,a,t){s.exports=t.p+"assets/img/docker_pull.39bb392e.png"},554:function(s,a,t){"use strict";t.r(a);var e=t(25),r=Object(e.a)({},(function(){var s=this,a=s.$createElement,e=s._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"实战-dockerfile-最小实践-koa为例"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#实战-dockerfile-最小实践-koa为例"}},[s._v("#")]),s._v(" 实战：dockerfile 最小实践——koa为例")]),s._v(" "),e("h2",{attrs:{id:"前言"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[s._v("#")]),s._v(" 前言")]),s._v(" "),e("p",[s._v("最小实践，意味着将链路打通，站在更高的层面看问题，问题就变得清晰，这一章，我将带你实现一个最简单的koa服务，并将其部署至服务器上。")]),s._v(" "),e("p",[s._v("先决知识：对"),e("RouterLink",{attrs:{to:"/Docker/Docker/docker基本介绍.html"}},[s._v("docker有一定的了解")])],1),s._v(" "),e("h2",{attrs:{id:"实现思路"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#实现思路"}},[s._v("#")]),s._v(" 实现思路")]),s._v(" "),e("p",[s._v("第一步：先启动一个 koa 应用，")]),s._v(" "),e("p",[s._v("第二步：再生成一个 dockerfile ，并编写它")]),s._v(" "),e("p",[s._v("第三步：基于 dockerfile 生成镜像（docker build）")]),s._v(" "),e("p",[s._v("第四步：基于此镜像生成（run）一个容器，检查在本机上是否跑的通")]),s._v(" "),e("p",[s._v("第五步：如果通，就导出此镜像")]),s._v(" "),e("p",[s._v("第六步：xshell连接服务器上（假设服务器上已安装docker），导入此镜像，通过此镜像生成一容器")]),s._v(" "),e("p",[s._v("这就是最小实现")]),s._v(" "),e("p",[s._v("这里还有一种实现方式：")]),s._v(" "),e("p",[s._v("在第五步时，把它发布到远端仓库，第六步，从远端拉取到镜像，但缺点是，你的镜像要公开（只有一个私有名额）")]),s._v(" "),e("h2",{attrs:{id:"第一步-先启动一个-koa-应用"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#第一步-先启动一个-koa-应用"}},[s._v("#")]),s._v(" 第一步：先启动一个 koa 应用")]),s._v(" "),e("p",[s._v("新建一个 dockerfile_koa_demo 文件，npm init -y 生成package.json。下载koa包，新建 app.js")]),s._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" dockerfile_koa_demo\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" dockerfile_koa_demo\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" init -y\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" i koa --save\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("touch")]),s._v(" app.js\n")])])]),e("p",[s._v("再编写app.js")]),s._v(" "),e("div",{staticClass:"language-javascript extra-class"},[e("pre",{pre:!0,attrs:{class:"language-javascript"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" Koa "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("require")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'koa'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" app "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Koa")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\napp"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("use")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("async")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("ctx")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    ctx"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("body "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'hello, docker'")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\napp"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("listen")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("3010")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    console"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'3010端口已启动'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])])]),e("p",[s._v("修改package.json 的script")]),s._v(" "),e("div",{staticClass:"language-json extra-class"},[e("pre",{pre:!0,attrs:{class:"language-json"}},[e("code",[s._v("...\n"),e("span",{pre:!0,attrs:{class:"token property"}},[s._v('"scripts"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[s._v('"start"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nodemon app.js"')]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n...\n")])])]),e("p",[s._v("启动脚本")]),s._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" run start\n")])])]),e("p",[s._v("看到如下图所示：")]),s._v(" "),e("p",[e("img",{attrs:{src:t(408),alt:"dockerfile_脚本"}})]),s._v(" "),e("p",[s._v("浏览器访问正常")]),s._v(" "),e("h2",{attrs:{id:"第二步-写个dockerfile文件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#第二步-写个dockerfile文件"}},[s._v("#")]),s._v(" 第二步：写个Dockerfile文件")]),s._v(" "),e("p",[s._v("新建一个 Dockerfile 文件")]),s._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("touch")]),s._v(" Dockerfile\n")])])]),e("p",[s._v("编写 Dockerfile")]),s._v(" "),e("div",{staticClass:"language-dockerfile extra-class"},[e("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# base image")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# FROM ")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token instruction"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" node")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 复制文件到容器")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token instruction"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ADD")]),s._v(" . /home/www")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 进入工作目录")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token instruction"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /home/www")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装项目依赖包")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token instruction"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" npm install --registry=https://registry.npm.taobao.org")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 暴露 端口")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token instruction"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("EXPOSE")]),s._v(" 3010")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 开始命令")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token instruction"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CMD")]),s._v(" ["),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"node"')]),s._v(", "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"./app.js"')]),s._v("]")]),s._v("\n\n")])])]),e("p",[s._v("第二步写完了")]),s._v(" "),e("h2",{attrs:{id:"第三步-基于-dockerfile-生成镜像"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#第三步-基于-dockerfile-生成镜像"}},[s._v("#")]),s._v(" 第三步：基于 dockerfile 生成镜像")]),s._v(" "),e("p",[s._v("为了加快构建速度，我们先生成 "),e("code",[s._v(".dockerignore")]),s._v(" ，并往里写上 "),e("code",[s._v("node_modules")])]),s._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("touch")]),s._v(" .dockerignore\n")])])]),e("p",[s._v("在 "),e("code",[s._v(".dockerignore")]),s._v("  里写入 "),e("code",[s._v("node_modules")]),s._v(" ，意思是说当你 "),e("code",[s._v("docker build")]),s._v(" 的时候忽略 "),e("code",[s._v("node_modules")]),s._v(" 文件，加快构建速度")]),s._v(" "),e("p",[s._v("通过命令行生成镜像，命名 johan/koa_server:v1.0.0")]),s._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("docker build "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v(" -t johan/koa_server:v1.0.0\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# -t 就是给镜像起名")]),s._v("\n")])])]),e("p",[s._v("效果如下图所示：")]),s._v(" "),e("p",[e("img",{attrs:{src:t(409),alt:"docker_build"}})]),s._v(" "),e("p",[s._v("查看镜像是否有了")]),s._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("docker images\n")])])]),e("h2",{attrs:{id:"第四步-基于此镜像生成一容器"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#第四步-基于此镜像生成一容器"}},[s._v("#")]),s._v(" 第四步：基于此镜像生成一容器")]),s._v(" "),e("p",[s._v("命令行生成一容器")]),s._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("docker run -d --name koa_server_container -p "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("3010")]),s._v(":3010 johan/koa_server:v1.0.0\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# -d 后台运行 ")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# --name 给容器起名字")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# -p 本机端口隐射镜像中的端口")]),s._v("\n")])])]),e("p",[s._v("查看镜像是否生成")]),s._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("docker "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" -a \n")])])]),e("p",[s._v("在浏览器中输入"),e("code",[s._v("http://localhost:3010/")]),s._v(" ,bingo")]),s._v(" "),e("h2",{attrs:{id:"第五步-导出此镜像"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#第五步-导出此镜像"}},[s._v("#")]),s._v(" 第五步：导出此镜像")]),s._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("docker save johan/koa_server:v1.0.0 "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" koa_server.tar\n")])])]),e("p",[e("img",{attrs:{src:t(410),alt:"导出镜像"}})]),s._v(" "),e("h2",{attrs:{id:"第六步-在服务器上跑通"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#第六步-在服务器上跑通"}},[s._v("#")]),s._v(" 第六步：在服务器上跑通")]),s._v(" "),e("p",[s._v("这里我们假设服务器上已经安装了 docker 以及 lrzsz 包（本文具体不展开）")]),s._v(" "),e("p",[s._v("通过xshell连接服务器，通过命令rz上传 tar包")]),s._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("rz\n")])])]),e("p",[e("img",{attrs:{src:t(411),alt:"lrzsz上传镜像"}})]),s._v(" "),e("p",[s._v("解开此压缩包（导入）")]),s._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("docker load "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" koa_server.tar\n")])])]),e("p",[e("img",{attrs:{src:t(412),alt:"导入镜像"}})]),s._v(" "),e("p",[s._v("基于此容器生成容器")]),s._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("docker run -d --name koa_server_container -p "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("3010")]),s._v(":3010 johan/koa_server:v1.0.0\n")])])]),e("p",[s._v("并查看跑通的容器")]),s._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("docker "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" -a \n")])])]),e("p",[s._v("在浏览器中输入域名，bingo")]),s._v(" "),e("p",[s._v("以上就是一个 "),e("code",[s._v("dockerfile")]),s._v(" 的最小实现，是不是很简单。当然，你可以再第五步时将镜像上传至"),e("code",[s._v("docker hub")]),s._v("，第六步从 "),e("code",[s._v("dockerfile")]),s._v(" 拉取镜像，再生成容器。如下")]),s._v(" "),e("h2",{attrs:{id:"另一种方法第五步-上传镜像"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#另一种方法第五步-上传镜像"}},[s._v("#")]),s._v(" 另一种方法第五步：上传镜像")]),s._v(" "),e("p",[s._v("命令行登录 dockerhub（首先要先注册）")]),s._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("docker login\n")])])]),e("p",[s._v("给镜像命名")]),s._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("docker tag johan/koa_server:v1.0.0 johanbo/koa_server:v1.0.0\n")])])]),e("p",[s._v("将镜像上传至 docker hub")]),s._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("docker push johanbo/koa_server:v1.0.0\n")])])]),e("p",[e("img",{attrs:{src:t(413),alt:"docker_push"}})]),s._v(" "),e("h2",{attrs:{id:"另一种方法第六步-拉取镜像"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#另一种方法第六步-拉取镜像"}},[s._v("#")]),s._v(" 另一种方法第六步：拉取镜像")]),s._v(" "),e("p",[s._v("登录服务器，并拉取镜像")]),s._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("docker pull johanbo/koa_server:v1.0.0\n")])])]),e("p",[e("img",{attrs:{src:t(414),alt:"docker_pull"}})]),s._v(" "),e("blockquote",[e("p",[e("strong",[s._v("注意")]),s._v("：这里需要打标签，否则会默认拉取latest")])]),s._v(" "),e("p",[s._v("启动容器")]),s._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("docker run -d --name koa_server_container -p "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("3010")]),s._v(":3010 johan/koa_server:v1.0.0\n")])])]),e("p",[s._v("在浏览器中输入域名，bingo")]),s._v(" "),e("blockquote",[e("p",[s._v("注意：服务器开发端口需要去云服务商那里开发相应端口（安全组配置规则）")])]),s._v(" "),e("h2",{attrs:{id:"后续"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#后续"}},[s._v("#")]),s._v(" 后续")]),s._v(" "),e("p",[s._v("你可以在 "),e("code",[s._v("dockerfile")]),s._v(' 里配置你所需的环境变量，镜像生成的容器是个 "mini 服务器"，怎么倒腾都行，和整个服务器没有关系，所以你的应用不受环境影响。')]),s._v(" "),e("p",[s._v("在这里说一个痛点：即使你解决了环境问题，但是CICD也是个问题，如何更快捷的集成呢？接下来的一节我会介绍下，docker与jenkins 的结合，通过docker生成jenkins，jenkins 赋能CICD")])])}),[],!1,null,null,null);a.default=r.exports}}]);